# Data Analysis & Results

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(haven)
library(table1)
library(lubridate)
library(survival)
library(ggsurvfit)
library(gtsummary)
#library(ComparisonSurv)
library(survminer)
#library(tidycmprsk)
#library(condSURV)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}

#load visit 1 data
datav1 <- read_dta("data/analysis1.dta")
visit1 <- datav1 %>% dplyr :: select(subjid, visitdate, age, htn, diab3cat, idealhealthsmk, bmi3cat, totchol3cat)

#visit1 <- visit1 %>% rename(visitdate_v1 = visitdate)

#load adjudicated data

#data_allevtstroke <- read_sas("data/allevtstroke.sas7bdat", NULL)
#allevtstroke <- data_allevtstroke %>% dplyr :: select(subjid, Stroke, OHDStroke, eventdate)

data_incevtstroke <- read_sas("data/incevtstroke.sas7bdat", NULL)
incevtstroke <- data_incevtstroke %>% dplyr :: select(subjid, stroke, date, contactType)

#allevtstroke <- allevtstroke %>% rename(stroke_allevt = Stroke, ohdstroke = OHDStroke)

incevtstroke <- incevtstroke %>% rename(contacttype = contactType)

#data_adj <- full_join(allevtstroke, incevtstroke, by = "subjid")

# Create final data set

data <- full_join(incevtstroke, visit1, by = "subjid")
data <- na.omit(data)

```

```{r, echo = FALSE, warning = FALSE, message = FALSE}

#Create time variable (time from visit 1 until event/censoring date)
data <- data %>% mutate(time = difftime(date, visitdate))

#Create the survival object (created from time variable and if the event has taken place.)
obj <- Surv(data$time, data$stroke)
```

## K-M Plot {.unnumbered}

*
The K-M plot can be interpreted as:
   + X-axis: represents time in days
   + Y-axis: provides the probability of participants having remained stroke free since the start of the study
   + The line represents the survival curve of the cohort of participants based on the survival object
   + The shaded area is the 95% confidence interval
   + A vertical drop in the line indicates an event

*
Further interpretation can be noted as:
  + At time zero, the survival probability is 1.0 (100% of the participants are stroke free)
  + At time 2,500, the survival probability is .99 (99% of the participants are stroke free)
  + At time > 4,000 the the survival probability is < .98 (less than 98% of the participants are stroke free)


```{r, echo = FALSE, warning = FALSE, message = FALSE}
km <- survfit(obj ~1, data=data)

#km_struct <- str(km)

km_2 <- survfit2(obj ~ 1, data=data)

km_plot <- km_2 %>% ggsurvfit() + labs(title = "K-M Plot", x = "Time in Days", y = "Overall probability of Survival (Stroke Free)") + add_confidence_interval() + add_risktable()


km_plot
```

## Cox Proportion Hazards Model  {.unnumbered}

```{r, echo = FALSE, warning = FALSE, message = FALSE}

#Transform data
data$stroke <- as.factor(data$stroke)
data$htn <- as.factor(data$htn)
data$diab3cat <- as.factor(data$diab3cat)
data$idealhealthsmk <- as.factor(data$idealhealthsmk)
data$totchol3cat <- as.factor(data$totchol3cat)
data$bmi3cat <- as.factor(data$bmi3cat)

##Label data
label(data$stroke) <- "Adjudicated Stroke Occurrance"
levels(data$stroke) <- c("No Stroke", "Adjudicated Stroke")

label(data$htn) <- "Hypertensive Status"
levels(data$htn) <- c("Normal/Pre-Hypertensive", "Hypertensive")

label(data$diab3cat) <- "Diabetes Categorization"
levels(data$diab3cat) <- c("Non-Diabetic", "Pre-Diabetic", "Diabetic")

label(data$idealhealthsmk) <- "Smoking Status"
levels(data$idealhealthsmk) <- c("Current Smoker","Never Smoked/Quit + 12 months")

label(data$bmi3cat) <- "AHA BMI Categorization"
levels(data$bmi3cat) <- c("Obese","Overweight","Normal Weight")

label(data$totchol3cat) <- "AHA Total Cholesterol Categorization"
levels(data$totchol3cat) <- c("Poor Health","Intermediate Health","Ideal Health")

cox <- coxph(obj ~ age + htn + diab3cat + idealhealthsmk + bmi3cat + totchol3cat, data=data)

# cox <- coxph(obj ~ age + as.factor(htn) + as.factor(diab3cat) + as.factor(idealhealthsmk) + as.factor(bmi3cat) + as.factor(totchol3cat), data=data)

cox_table <- cox %>% tbl_regression(exp = TRUE) 
cox_table
```


+ Of interest from the Cox regression is the hazard ratio (HR) (Zabor).
  + HR < 1 indicates a reduced hazard of stroke
  + HR > 1 indicates an increased hazard of death
  
As an example, the HR of 0.69 for a participant in intermediate health, as defined by their cholesterol categorization, implies that 0.69 of those in the intermediate health status has a lower hazard of stroke than those in the poor health category.

Alternately, the HR of 1.10 in a hypertensive participant implies that there is an increase hazard of stroke than those in a non-hypertensive status.




### Hazard Curve {.unnumbered}
*
The Cox PH Curve can be interpreted as:
   + X-axis: represents time in days
   + Y-axis: provides the probability of participants having a stroke since the start of the study
   + The line represents the hazard curve of the cohort of participants based on the survival object
   + The shaded area is the 95% confidence interval
   + A vertical climb in the line indicates an event

*
Further interpretation can be noted as:
  + At time zero, the hazard probability is 0.0 (0% of the participants have had a stroke since joining the study)
  + At time 2,500, the hazard probability is .01 (1% of the participants have had a stroke since joining the study)
  + At time > 4,000 the the hazard probability is > .02 (greater than 2% of the participants have had a stroke since joining the study)

```{r, echo = FALSE, warning = FALSE, message = FALSE}
fit <- survfit(obj ~ 1, data = data)
ggsurvplot(fit, fun = function(y) -log(y), data = data, title = "Hazard Curve", xlab = "Time in days", ylab = "Probablity of Hazard (Stroke)", palette = "#2E9FDF")
```
